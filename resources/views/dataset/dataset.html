<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar dataset</title>
    <style>
        ${d.bootstrapCss}
        ${d.datatablesCss}

        #tbResultDataset th, #tbResultDataset td {
            white-space: nowrap;
        }
    </style>
</head>
    <body class="container-fluid">
        <div class="row">
            <div class="col-md-4 form-group">
                <label for="servidor"><strong>Servidor</strong></label>
                <select class="form-control" id="servidor" onchange="selectServerAction(this);">
                    <option value="">Selecionar</option>
                    ${d.servidores}
                </select>
            </div>

            <div class="col-md-8 form-group">
                <label for="dataset"><strong>Dataset</strong></label>
                <div class="input-group mb-3">
                    <select class="form-control" id="dataset">
                        <option value="">Selecionar</option>
                    </select>
                    <div class="input-group-append">
                        <button class="btn btn-success" onclick="getResultQuery();">Atualizar</button>
                    </div>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#modalConfigFiltro">Configurar filtro</button>
                    </div>
                </div>
            </div>
        </div>

        <table id="tbResultDataset" class="table table-striped table-sm table-bordered"></table>

        <!-- Inicio Modal Constraints-->
        <div class="modal fade" id="modalConfigFiltro" tabindex="-1" role="dialog" aria-labelledby="modalConfigFiltro" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" id="constraints-tab" data-toggle="tab" href="#tabConstraints" role="tab" aria-controls="tabConstraints" aria-selected="true">Constraints</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="fields-tab" data-toggle="tab" href="#tabFields" role="tab" aria-controls="tabFields" aria-selected="false">Fields</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="orders-tab" data-toggle="tab" href="#tabOrders" role="tab" aria-controls="tabOrders" aria-selected="false">Order</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            <div id="tabConstraints" class="tab-pane fade show active" role="tabpanel" aria-labelledby="tabConstraints">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm" id="constraints">
                                        <thead class="thead-light">
                                            <tr>
                                                <th scope="col" width="30%">Coluna</th>
                                                <th scope="col" width="15%">Valor inicial</th>
                                                <th scope="col" width="15%">Valor final</th>
                                                <th scope="col" width="15%">Tipo</th>
                                                <th scope="col" width="15%" colspan="2">Busca usa 'like'</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <select class="form-control" id="campo___1">
                                                        <option value="sqlLimit" selected>sqlLimit</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" id="valor_inicial___1" value="100">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" id="valor_final___1" value="100">
                                                </td>
                                                <td>
                                                    <select class="form-control" id="tipo___1">
                                                        <option value="MUST" selected>MUST</option>
                                                        <option value="MUST_NOT">MUST NOT</option>
                                                        <option value="SHOULD">SHOULD</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select class="form-control" id="like___1">
                                                        <option value="NAO" selected>Não</option>
                                                        <option value="SIM">Sim</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <a href="#" style="float: left; margin: 5px 0;" onclick="removeConstraints(this);">X</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row">
                                    <dic class="col-md-12">
                                        <button type="button" class="btn btn-primary" style="float: right;" onclick="addConstraints();">Adicionar</button>
                                    </dic>
                                </div>
                            </div>
                            <div id="tabFields" class="tab-pane fade" role="tabpanel" aria-labelledby="tabFields">
                                <div class="row">
                                    <div class="col-md-6 form-group">
                                        <label for="fields">
                                            <strong>Colunas do dataset</strong>
                                        </label>
                                        <select multiple class="form-control" id="fields">
                                        </select>
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label for="fieldsSelected">
                                            <strong>Colunas selecionadas</strong>
                                        </label>
                                        <select multiple class="form-control" id="fieldsSelected">
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="tabOrders" class="tab-pane fade" role="tabpanel" aria-labelledby="tabOrders">
                                <div class="row">
                                    <div class="col-md-6 form-group">
                                        <label for="order">
                                            <strong>Colunas do dataset</strong>
                                        </label>
                                        <select multiple class="form-control" id="order">
                                        </select>
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label for="orderSelected">
                                            <strong>Colunas selecionadas</strong>
                                        </label>
                                        <select multiple class="form-control" id="orderSelected">
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <dic class="col-md-12">
                                <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Fechar</button>
                                <button type="button" class="btn btn-info" data-dismiss="modal" aria-label="Close" onclick="getResultQuery();">Atualizar</button>
                            </dic>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fim Modal Constraints-->
        <script type="text/javascript">${d.jquery}</script>
        <script type="text/javascript">${d.bootstrapJs}</script>
        <script type="text/javascript">${d.datatablesJs}</script>
        <script type="text/javascript">
            const vscode = acquireVsCodeApi();
            let dataTable = null;
            let FIELDS = [];

            window.addEventListener('message', event => {
                const message = event.data;
                switch (message.command) {
                    case 'list_dataset':
                        const select = document.getElementById("dataset");
                        const datasets = message.listDataset;

                        for(let dataset of datasets) {
                            const option = new Option(dataset.datasetId, dataset.datasetId);
                            select.add(option);
                        }
                        break;
                    case 'query_result':
                        const queryResult = message.queryResult
                        // Atualizar as fields
                        // Atualizar as orders
                        setFields(queryResult);
                        setConstraints(queryResult);
                        updateTableResult(queryResult);
                        break;
                }
            });

            function updateTableResult(queryResult) {
                const {columns, values} = queryResult;

                const tbResult = document.getElementById('tbResultDataset');
                const $tbResult = $(tbResult);

                if (dataTable) {
                    dataTable.destroy();
                    $tbResult.find("body").empty();
                    dataTable = null;
                }


                tbResult.innerHTML = "";

                // Montando cabeçalho da tabela
                const header = tbResult.createTHead();
                const title = header.insertRow();

                for (let columnName of columns) {
                    const column = document.createElement('th');
                    column.innerHTML = columnName;
                    title.appendChild(column);
                }

                // Listando os registros
                const records = tbResult.appendChild(document.createElement('tbody'));

                for(let value of values) {
                    const row = records.insertRow();

                    for(let columnName of columns) {
                        row.insertCell().innerHTML = value[columnName];
                    }
                }

                tbResult.appendChild(records);

                dataTable = $tbResult.DataTable({
                    order: [],
                    fixedHeader: true,
                    dom: '<lf><rt><ip><B>',
                    buttons: ['copy', 'excel'],
                });
            }

            function getResultQuery() {
                const server = document.getElementById("servidor");
                if(!server.value) {
                    // Erro: Por favor, informar um servidor fluig
                    return;
                }

                const dataset = document.getElementById("dataset");
                if(!dataset.value) {
                    // Erro: Por favor, informar um dataset
                    return;
                }

                const _constraints = getConstraints();

                vscode.postMessage({
                    command: 'consult_dataset',
                    serverId: server.value,
                    datasetId: dataset.value,
                    constraints: _constraints
                });
            }

            function getIndexConstraints() {
                const linhas = document.querySelectorAll('select[id^="campo___"]');

                if(linhas.length < 1) return 1;

                const ultimaLinha = linhas[linhas.length - 1];
                const indice = ultimaLinha.id.split("___")[1];
                return parseInt(indice) + 1;
            }

            function removeConstraints(element) {
                element.parentElement.parentElement.remove();
            }

            function addConstraints() {
                const indice = getIndexConstraints();
                let linhaModelo = "";
                linhaModelo += '<tr> ';
                linhaModelo += '    <td> ';
                linhaModelo += '        <select class="form-control" id="campo___' + indice + '"> ';
                linhaModelo += '        </select> ';
                linhaModelo += '    </td> ';
                linhaModelo += '    <td> ';
                linhaModelo += '        <input type="text" class="form-control" id="valor_inicial___' + indice + '"> ';
                linhaModelo += '    </td> ';
                linhaModelo += '    <td> ';
                linhaModelo += '        <input type="text" class="form-control" id="valor_final___' + indice + '"> ';
                linhaModelo += '    </td> ';
                linhaModelo += '    <td> ';
                linhaModelo += '        <select class="form-control" id="tipo___' + indice + '"> ';
                linhaModelo += '            <option value="1">MUST</option> ';
                linhaModelo += '            <option value="3">MUST NOT</option> ';
                linhaModelo += '            <option value="2">SHOULD</option> ';
                linhaModelo += '        </select> ';
                linhaModelo += '    </td> ';
                linhaModelo += '    <td> ';
                linhaModelo += '        <select class="form-control" id="like___' + indice + '"> ';
                linhaModelo += '            <option value="NAO">Não</option> ';
                linhaModelo += '            <option value="SIM">Sim</option> ';
                linhaModelo += '        </select> ';
                linhaModelo += '    </td> ';
                linhaModelo += '    <td> ';
                linhaModelo += '        <a href="#" style="float: left; margin: 5px 0;" onClick="removeConstraints(this);">X</a> ';
                linhaModelo += '    </td> ';
                linhaModelo += '</tr> ';

                $("#constraints tbody").append(linhaModelo);

                const select = document.getElementById("campo___" + indice);
                const optionsName = FIELDS.slice();

                // OPCOES QUE PODEM SER PASSADA VIA CONSTRAINTS
                optionsName.push(
                    "sqlLimit",
                    "tablename"
                );

                for(let optionName of optionsName) {
                    const option = new Option(optionName, optionName);
                    select.add(option);
                }

                return indice;
            }

            function setConstraints(queryResult) {
                const {values} = queryResult;

                // REMOVER AS CONSTRAINTS
                document.querySelectorAll('select[id^="campo___"]').forEach((item) => {
                    removeConstraints(item);
                });

                const index = addConstraints();

                document.getElementById("campo___" + index).value = "sqlLimit"
                document.getElementById("valor_inicial___" + index).value = "100";
                document.getElementById("valor_final___" + index).value = "100";
                document.getElementById("tipo___" + index).value == "1";
                document.getElementById("like___" + index).value == "NAO";
            }

            function getConstraints() {
                const fields = document.querySelectorAll('select[id^="campo___"]');
                const constraints = [];

                for(let field of fields) {
                    const index = field.id.replace("campo___", "");

                    constraints.push({
                        fieldName: field.value,
                        initialValue: document.getElementById("valor_inicial___" + index).value,
                        finalValue: document.getElementById("valor_final___" + index).value,
                        contraintType: document.getElementById("tipo___" + index).value,
                        likeSearch: (document.getElementById("like___" + index).value == "SIM")
                    });
                }

                return constraints;
            }

            function setFields(queryResult) {
                const {columns} = queryResult;

                FIELDS = columns;

                const selectFields = document.getElementById("fields");
                for(let optionName of columns) {
                    const option = new Option(optionName, optionName);
                    selectFields.add(option);
                }

                const selectOrder = document.getElementById("order");
                for(let optionName of columns) {
                    const option = new Option(optionName, optionName);
                    selectOrder.add(option);
                }
            }

            function selectServerAction(element) {
                const select = document.getElementById("dataset");

                for(let indice = (select.length - 1); indice >= 0; indice--) {
                    select.remove(indice);
                }

                const option = new Option("Selecionar", "");
                select.add(option);

                if(!element.value) return;

                vscode.postMessage({
                    command: 'list_dataset',
                    serverId: element.value
                });
            }
        </script>
    </body>
</html>
